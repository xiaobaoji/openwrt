name: 自动编译 UGREEN-fanchmwrt 固件
on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_branch:
        description: '选择编译分支'
        required: true
        default: 'fanchmwrt-24.10.4'
        type: choice
        options:
          - fanchmwrt-24.10.4
          - openwrt-main
      build_target:
        description: '选择目标架构'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - x86_64
          - aarch64_cortex-a53
          - aarch64_cortex-a72
          - mipsel_24kc
      ssh_connect:
        description: '启用 SSH 连接'
        required: false
        default: 'false'
        type: boolean
      upload_release:
        description: '上传到 Releases'
        required: false
        default: 'true'
        type: boolean
      keep_releases:
        description: '保留最新版本数'
        required: false
        default: '3'
        type: number

env:
  REPO_URL: https://github.com/fanchmwrt/fanchmwrt
  REPO_BRANCH: ${{ github.event.inputs.build_branch || 'fanchmwrt-24.10.4' }}
  TARGET_ARCH: ${{ github.event.inputs.build_target || 'x86_64' }}
  BUILD_DIR: ${{ github.workspace }}/openwrt
  DIY_PATH: ${{ github.workspace }}/diy
  MAKE_JOBS: ${{ github.event.inputs.make_jobs || 'auto' }}
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: 检出版本库
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          path: ${{ github.workspace }}

      - name: 初始化编译环境
        run: |
          sudo apt update -y && sudo apt upgrade -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib gettext git libncurses5-dev \
          libssl-dev python3-distutils rsync unzip zlib1g-dev file wget curl python3-pip libpython3-dev \
          ninja-build cmake ccache libelf-dev libfuse-dev pkgconf autoconf automake autopoint texinfo \
          libreadline-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev swig upx-ucl
          sudo timedatectl set-timezone "$TZ"
          pip3 install requests

      - name: 克隆 fanchmwrt 源码
        run: |
          git clone --depth 1 -b $REPO_BRANCH $REPO_URL $BUILD_DIR
          cd $BUILD_DIR
          echo "当前源码分支：$(git branch -v)"

      - name: 执行自定义脚本（整合双插件）
        run: |
          cd $BUILD_DIR
          # 加载自定义脚本
          chmod +x $DIY_PATH/scripts/diy.sh
          $DIY_PATH/scripts/diy.sh

      - name: 加载架构配置文件
        run: |
          cd $BUILD_DIR
          if [ -f "$DIY_PATH/config/${TARGET_ARCH}.config" ]; then
              cp $DIY_PATH/config/${TARGET_ARCH}.config .config
              echo "已加载 ${TARGET_ARCH} 架构配置"
          else
              make defconfig
              echo "使用默认配置"
          fi
          # 应用配置
          make defconfig

      - name: SSH 远程调试（可选）
        if: github.event.inputs.ssh_connect == 'true'
        uses: danshui-git/debugger-action@main
        with:
          mode: tmate
          command: cd $BUILD_DIR && echo "SSH 连接成功，可执行 make menuconfig 调整配置"

      - name: 编译缓存加速
        uses: klever1988/cachewrtbuild@main
        with:
          ccache: 'true'
          mixkey: ${{ REPO_BRANCH }}-${{ TARGET_ARCH }}
          prefix: $BUILD_DIR

      - name: 开始编译固件
        run: |
          cd $BUILD_DIR
          MAKE_JOBS=${MAKE_JOBS:-$(nproc)}
          echo "编译线程数：$MAKE_JOBS"
          echo "目标架构：$TARGET_ARCH"
          # 下载依赖
          make download -j$MAKE_JOBS V=s
          # 清理无效文件
          find dl -size -1024c -exec rm -f {} \;
          # 编译（失败降级单线程）
          make -j$MAKE_JOBS || make -j1 V=s

      - name: 整理编译产物
        run: |
          cd $BUILD_DIR
          mkdir -p ${{ github.workspace }}/output
          # 复制固件和配置文件
          find bin/targets -name "*.bin" -o -name "*.img" -exec cp {} ${{ github.workspace }}/output/ \;
          cp .config ${{ github.workspace }}/output/${TARGET_ARCH}-config-${{ github.sha }}.config
          # 生成产物清单
          ls -l ${{ github.workspace }}/output > ${{ github.workspace }}/output/固件清单.txt

      - name: 上传到 Artifacts
        uses: actions/upload-artifact@main
        with:
          name: UGREEN-fanchmwrt-${{ REPO_BRANCH }}-${{ TARGET_ARCH }}
          path: ${{ github.workspace }}/output/*
          retention-days: 15

      - name: 发布到 Releases
        if: github.event.inputs.upload_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: UGREEN-${{ REPO_BRANCH }}-${{ TARGET_ARCH }}-${{ github.run_number }}
          name: UGREEN-fanchmwrt 固件 ${{ REPO_BRANCH }}-${{ TARGET_ARCH }}
          body: |
            ## 编译信息
            - 源码分支：${{ REPO_BRANCH }}
            - 目标架构：${{ TARGET_ARCH }}
            - 编译时间：$(date +"%Y-%m-%d %H:%M:%S")
            - 设备名：UGREEN
            - 登录 IP：192.168.123.2
            - 登录密码：无（直接登录）
            - 内置插件：Passwall、Nikki、Argon 主题
          files: ${{ github.workspace }}/output/*
          keep_latest: ${{ github.event.inputs.keep_releases }}

      - name: 清理旧工作流
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 7
          keep_minimum_runs: 3
