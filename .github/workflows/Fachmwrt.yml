# Fanchmwrt-UGREEN-x64 äº‘ç¼–è¯‘å·¥ä½œæµï¼ˆä¿®å¤åˆ†æ”¯ç©ºå€¼é—®é¢˜ï¼‰
name: Fanchmwrt-UGREEN-x64
on:
  workflow_dispatch:
    inputs:
      REPO_BRANCH_MAIN:
        description: 'fanchmwrtä¸»åˆ†æ”¯é€‰æ‹©'
        required: true
        default: 'fanchmwrt-24.10.4'
        type: choice
        options:
          - 'fanchmwrt-24.10.4'
      REPO_BRANCH_OPENWRT:
        description: 'openwrtåŸºç¡€åˆ†æ”¯é€‰æ‹©ï¼ˆå¿…å¡«ï¼‰'
        required: true  # å¼ºåˆ¶å¿…å¡«ï¼Œé¿å…ç©ºå€¼
        default: 'fanchmwrt-24.10.4'  # è®¾ä¸ºä»“åº“å®é™…å­˜åœ¨çš„åˆ†æ”¯ï¼ˆè¯·ç¡®è®¤ä»“åº“åˆ†æ”¯åï¼Œè‹¥ä¸æ˜¯mainéœ€ä¿®æ”¹ï¼‰
        type: choice
        options:
          - 'fanchmwrt-24.10.4'  # ä»…ä¿ç•™ä»“åº“å®é™…å­˜åœ¨çš„åˆ†æ”¯
      CONFIG_FILE:
        description: 'è¯·é€‰æ‹©[seedæ–‡ä»¶å¤¹å†…]çš„é…ç½®æ–‡ä»¶'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - 'x86_64'
      CPU_SELECTION:
        description: 'CPUä¼˜é€‰,å¢åŠ ç¼–è¯‘é€Ÿåº¦'
        required: true
        default: 'é»˜è®¤'
        type: choice
        options:
          - 'é»˜è®¤'
          - '8370C'
          - '8272CL'
          - '8171M'
      INFORMATION_NOTICE:
        description: 'Telegramæˆ–pushplusä¿¡æ¯é€šçŸ¥'
        required: true
        default: 'Telegram'
        type: choice
        options:
          - 'å…³é—­'
          - 'Telegram'
          - 'Pushplus'
      SSH_ACTION:
        description: 'SSHè¿œç¨‹é…ç½®å›ºä»¶'
        required: false
        default: 'false'
        type: boolean
      UPLOAD_FIRMWARE:
        description: 'ä¸Šä¼ å›ºä»¶åˆ° Github Artifacts'
        required: false
        default: 'true'
        type: boolean
      UPLOAD_RELEASE:
        description: 'å‘å¸ƒå›ºä»¶åˆ° Github Releases'
        required: false
        default: 'true'
        type: boolean
      CACHEWRTBUILD_SWITCH:
        description: 'ç¼“å­˜åŠ é€Ÿç¼–è¯‘'
        required: false
        default: 'true'
        type: boolean
      UPDATE_FIRMWARE_ONLINE:
        description: 'å¢åŠ åœ¨çº¿æ›´æ–°å›ºä»¶åŠŸèƒ½'
        required: false
        default: 'true'
        type: boolean
      COMPILATION_INFORMATION:
        description: 'æ˜¯å¦æ˜¾ç¤ºç¼–è¯‘ä¿¡æ¯'
        required: false
        default: 'true'
        type: boolean
  # å®šæ—¶è§¦å‘å¼€å¯å¼€å§‹ç¼–è¯‘(æŠŠä¸‹é¢ä¸¤ä¸ª#å»æ‰å¼€å¯)
  # schedule:
  #   - cron: 35 18 * * *
env:
  GITHUB_LINK: https://github.com/${{github.repository}}
  GIT_ACTOR: ${{github.actor}}
  GIT_REPOSITORY: ${{github.repository}}
  RUN_NUMBER: ${{github.run_number}}
  RUN_WORKFLOW: ${{github.workflow}}
  REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
  PUSH_PLUS_TOKEN: ${{ secrets.PUSH_PLUS_TOKEN }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  WX_TOKEN: ${{ secrets.WX_TOKEN }}
  CURL: ${{ secrets.CURL }}
  TZ: Asia/Shanghai
  LC_ALL: C
  LANG: C
  LANGUAGE: C
  # è‡ªå®šä¹‰æ ¸å¿ƒé…ç½®ï¼ˆé€‚é…éœ€æ±‚ï¼‰
  REPO_URL: https://github.com/fanchmwrt/fanchmwrt
  CONFIG_REPO_URL: https://github.com/xiaobaoji/openwrt
  NIKKI_REPO_URL: https://github.com/nikkinikki-org/OpenWrt-nikki
  LAN_IP: 192.168.123.2
  DEVICE_NAME: UGREEN
  ROOTFS_SIZE: 1024
  FILESYSTEM: squashfs
jobs:
  build:
    name: å¯åŠ¨"${{ matrix.target }}-${{ github.event.inputs.REPO_BRANCH_MAIN }}"è§¦å‘ç¼–è¯‘
    runs-on: ubuntu-22.04
    if: ${{ github.event.repository.owner.id }} == ${{ github.event.sender.id }}
    env:
      FOLDER_NAME: ${{ matrix.target }}
    strategy:
      fail-fast: false
      matrix:
        target: [Fanchmwrt]
        # è¯·å‹¿å¯¹ target: [Fanchmwrt] åšä»»ä½•ä¿®æ”¹
    steps:
      - name: å¯†åŒ™æ£€æµ‹ï¼ˆå¯†åŒ™ä¸ºç©ºåˆ™é€€å‡ºï¼‰
        run: |
          cd ${GITHUB_WORKSPACE}
          if [[ -z "${{ secrets.REPO_TOKEN }}" ]]; then
            echo "æ‚¨æ²¡æœ‰è®¾ç½®ä»“åº“å¯†åŒ™ï¼Œè¯·æŒ‰æ•™ç¨‹è®¾ç½®å¥½å¯†åŒ™å†æ¥"
            echo "REPO_TOKENå¯†åŒ™åˆ¶ä½œæ•™ç¨‹ï¼šhttps://git.io/jm.md"
            exit 1
          fi
      - name: å‡†å¤‡ç»“æŸ
        uses: actions/checkout@v4
      - name: æ£€æµ‹æœ¬åœ°å…³é”®æ–‡ä»¶ï¼ˆæ— ä¸Šæ¸¸åŒæ­¥ï¼‰
        run: |
          cd ${GITHUB_WORKSPACE}
          # æ£€æŸ¥æœ¬åœ°æ ¸å¿ƒè‡ªå®šä¹‰æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆç¼ºå¤±åˆ™ç»ˆæ­¢ï¼‰
          required_files=(
            "seed/${{ github.event.inputs.CONFIG_FILE }}.config"
            "build/${{ env.FOLDER_NAME }}/diy-part.sh"
            "build/${{ env.FOLDER_NAME }}/settings.ini"
            "build/${{ env.FOLDER_NAME }}/common.sh"
          )
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "é”™è¯¯ï¼šæœ¬åœ°å…³é”®æ–‡ä»¶ $file ç¼ºå¤±ï¼Œè¯·è¡¥å……åå†ç¼–è¯‘"
              exit 1
            fi
          done
          # åŠ è½½æœ¬åœ°é…ç½®ä¸å·¥ä½œæµè¾“å…¥å˜é‡
          source ${GITHUB_WORKSPACE}/build/${{ env.FOLDER_NAME }}/settings.ini
          export INPUTS_REPO_BRANCH_MAIN="${{ github.event.inputs.REPO_BRANCH_MAIN }}"
          export INPUTS_REPO_BRANCH_OPENWRT="${{ github.event.inputs.REPO_BRANCH_OPENWRT }}"
          export INPUTS_CONFIG_FILE="${{ github.event.inputs.CONFIG_FILE }}"
          export INPUTS_CPU_SELECTION="${{ github.event.inputs.CPU_SELECTION }}"
          export INPUTS_INFORMATION_NOTICE="${{ github.event.inputs.INFORMATION_NOTICE }}"
          export INPUTS_SSH_ACTION="${{ github.event.inputs.SSH_ACTION }}"
          export INPUTS_UPLOAD_FIRMWARE="${{ github.event.inputs.UPLOAD_FIRMWARE }}"
          export INPUTS_UPLOAD_RELEASE="${{ github.event.inputs.UPLOAD_RELEASE }}"
          export INPUTS_CACHEWRTBUILD_SWITCH="${{ github.event.inputs.CACHEWRTBUILD_SWITCH }}"
          export INPUTS_UPDATE_FIRMWARE_ONLINE="${{ github.event.inputs.UPDATE_FIRMWARE_ONLINE }}"
          export INPUTS_COMPILATION_INFORMATION="${{ github.event.inputs.COMPILATION_INFORMATION }}"
          # æ‰§è¡Œæœ¬åœ°åˆå§‹åŒ–é€»è¾‘
          source build/${{ env.FOLDER_NAME }}/common.sh && Diy_menu1
      - name: éƒ¨ç½²ç¼–è¯‘ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update -y
          sudo -E apt-get -qq install -y gawk git gettext libssl-dev xsltproc zip git-core wget curl grep python2.7 python3 python3-pip libpython3-dev \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib libncurses5-dev zlib1g-dev file libelf-dev liblzma-dev binutils subversion patch
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /${{ env.DIY_WORK }}
          sudo chown $USER:$GROUPS /${{ env.DIY_WORK }}
      - name: ä¸‹è½½"${{ matrix.target }}-${{ github.event.inputs.REPO_BRANCH_MAIN }}"æºç ï¼ˆå¢åŠ åˆ†æ”¯ç©ºå€¼æ£€æŸ¥ï¼‰
        working-directory: /${{ env.DIY_WORK }}
        run: |
          # æ£€æŸ¥openwrtåŸºç¡€åˆ†æ”¯å˜é‡æ˜¯å¦ä¸ºç©º
          if [ -z "${{ github.event.inputs.REPO_BRANCH_OPENWRT }}" ]; then
            echo "é”™è¯¯ï¼šREPO_BRANCH_OPENWRTåˆ†æ”¯å˜é‡ä¸ºç©ºï¼Œè¯·é€‰æ‹©æœ‰æ•ˆåˆ†æ”¯"
            exit 1
          fi
          # å…‹éš†fanchmwrtä¸»åˆ†æ”¯
          git clone -b "${{ github.event.inputs.REPO_BRANCH_MAIN }}" --single-branch "${REPO_URL}" openwrt
          cd openwrt
          # åˆ‡æ¢åˆ°æŒ‡å®šçš„openwrtåŸºç¡€åˆ†æ”¯ï¼ˆç¡®ä¿åˆ†æ”¯å­˜åœ¨ï¼‰
          git fetch --depth 1 origin "${{ github.event.inputs.REPO_BRANCH_OPENWRT }}"
          git checkout "${{ github.event.inputs.REPO_BRANCH_OPENWRT }}"
          cd ..
          ln -sf /${{ env.DIY_WORK }}/openwrt ${GITHUB_WORKSPACE}/openwrt
          cp -Rf ${GITHUB_WORKSPACE}/build ${GITHUB_WORKSPACE}/openwrt/build
          chmod -R +x ${GITHUB_WORKSPACE}/openwrt/build
      - name: å…¬ å‘Š
        if: env.REPO_TOKEN
        run: |
          cd ${GITHUB_WORKSPACE}
          cd openwrt
          source ${BUILD_PATH}/common.sh && Diy_menu2
      - name: æ›´æ–°æ’ä»¶æº
        if: env.REPO_TOKEN
        run: |
          cd openwrt
          # é›†æˆnikkiæ’ä»¶æº
          echo "src-git nikki ${NIKKI_REPO_URL}" >> feeds.conf.default
          source ${BUILD_PATH}/common.sh && Diy_menu3
      - name: åŠ è½½è‡ªå®šä¹‰è®¾ç½®
        if: env.REPO_TOKEN
        run: |
          cd openwrt
          # æ›¿æ¢ä¸ºxiaobaojié…ç½®
          rm -rf .config
          git clone --depth 1 ${CONFIG_REPO_URL} config-temp
          cp config-temp/.config .config
          rm -rf config-temp
          # å®šåˆ¶å›ºä»¶æ ¸å¿ƒé…ç½®
          sed -i "s/192.168.1.1/${LAN_IP}/g" package/base-files/files/bin/config_generate
          sed -i "s/OpenWrt/${DEVICE_NAME}/g" package/base-files/files/bin/config_generate
          sed -i "s/CONFIG_TARGET_ROOTFS_PARTSIZE=.*/CONFIG_TARGET_ROOTFS_PARTSIZE=${ROOTFS_SIZE}/g" .config
          sed -i 's/root::0:0:99999:7:::/root::0:0:99999:7:::/g' package/base-files/files/etc/shadow
          echo "CONFIG_TARGET_x86=y" >> .config
          echo "CONFIG_TARGET_x86_64=y" >> .config
          echo "CONFIG_TARGET_IMAGES_img=y" >> .config
          echo "CONFIG_TARGET_IMAGES_${FILESYSTEM}=y" >> .config
          echo "CONFIG_TARGET_${FILESYSTEM}_BLOCKSIZE=256" >> .config
          echo "# CONFIG_TARGET_IMAGES_ext4fs is not set" >> .config
          source ${BUILD_PATH}/common.sh && Diy_menu4
      - name: å®‰è£…æ’ä»¶æº
        if: env.REPO_TOKEN
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          source ${BUILD_PATH}/common.sh && Diy_menu5
      - name: SSHè¿œç¨‹è¿æ¥ï¼ˆmake menuconfigï¼‰
        if: env.SSH_ACTION == 'true'
        uses: danshui-git/debugger-action@main
      - name: ç”Ÿæˆ"${{ matrix.target }}"é…ç½®æ–‡ä»¶
        if: env.REPO_TOKEN
        id: compile
        run: |
          cd openwrt
          make defconfig
          source ${BUILD_PATH}/common.sh && Diy_menu6
      - name: ä¸Šä¼ "${{ matrix.target }}"é…ç½®æ–‡ä»¶åœ¨ Github Artifacts
        if: steps.compile.outcome == 'success'
        uses: actions/upload-artifact@main
        with:
          name: .config_${{ env.SOURCE }}_${{ env.LUCI_EDITION }}_${{ env.TARGET_PROFILE }}_${{ env.Firmware_Date }}
          path: openwrt/build_logo/config.txt
      - name: ç¼–è¯‘ä¿¡æ¯
        continue-on-error: true
        if: env.COMPILATION_INFORMATION == 'true'
        run: |
          cd openwrt
          source ${BUILD_PATH}/common.sh && Diy_xinxi
      - name: æ¸…ç†Actionsç©ºé—´
        continue-on-error: true
        if: env.REPO_TOKEN
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.REPO_TOKEN }}
          repository: ${{ github.repository }}
          retain_min: ${{ env.RETAIN_MINUTE }}
      - name: æ¸…ç†releases
        continue-on-error: true
        if: env.REPO_TOKEN
        uses: ophub/delete-releases-workflows@main
        with:
          delete_releases: true
          releases_keep_keyword: targz/Update
          releases_keep_latest: ${{ env.KEEP_LATEST }}
          delete_tags: true
          delete_workflows: false
          workflows_keep_day: 90
          gh_token: ${{ secrets.REPO_TOKEN }}
      - name: è§¦å‘å¯åŠ¨"${{ matrix.target }}"å¼€å§‹ç¼–è¯‘
        id: gitpush
        if: steps.compile.outcome == 'success' && env.REPO_TOKEN
        run: |
          cd ${GITHUB_WORKSPACE}
          source ${BUILD_PATH}/common.sh && build_openwrt
      - name: Telegramæˆ–pushplusä¿¡æ¯é€šçŸ¥
        if: env.PUSH_PLUS_TOKEN && env.INFORMATION_NOTICE == 'Pushplus' || env.TELEGRAM_BOT_TOKEN && env.INFORMATION_NOTICE == 'Telegram'
        run: |
          if [[ "${{ env.INFORMATION_NOTICE }}" == "Telegram" ]]; then
            if [[ "${{steps.gitpush.outcome}}" == 'success' ]]; then
              curl -k --data chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" --data "text=ğŸ‰ ä¸»äººğŸ’•ï¼šæ‚¨çš„ç¼–è¯‘è„šæœ¬æˆåŠŸè§¦å‘ã€${{matrix.target}}ã€‘æ–‡ä»¶å¤¹ç¼–è¯‘ã€${{ github.event.inputs.REPO_BRANCH_MAIN }}åˆ†æ”¯+${{ github.event.inputs.REPO_BRANCH_OPENWRT }}åˆ†æ”¯çš„${{env.TARGET_PROFILE}}ã€‘å›ºä»¶ä¸­,è¯·è€å¿ƒç­‰å¾…...... ğŸ˜‹(${{env.WAREHOUSE_MAN}}ä»“åº“çš„#${{env.RUN_NUMBER}}å·)ï¼($(date +%Yå¹´%mæœˆ%då·%Hæ—¶%Måˆ†))ğŸ’" "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage"
            fi
          fi
          if [[ "${{ env.INFORMATION_NOTICE }}" == "Pushplus" ]]; then
            if [[ "${{steps.gitpush.outcome}}" == 'success' ]]; then
              curl -k --data token="${{ secrets.PUSH_PLUS_TOKEN }}" --data title="å¼€å§‹ç¼–è¯‘ã€${{matrix.target}}ã€‘" --data "content=ğŸ‰ ä¸»äººğŸ’•ï¼šæ‚¨çš„ç¼–è¯‘è„šæœ¬æˆåŠŸè§¦å‘ã€${{matrix.target}}ã€‘æ–‡ä»¶å¤¹ç¼–è¯‘ã€${{ github.event.inputs.REPO_BRANCH_MAIN }}åˆ†æ”¯+${{ github.event.inputs.REPO_BRANCH_OPENWRT }}åˆ†æ”¯çš„${{env.TARGET_PROFILE}}ã€‘å›ºä»¶ä¸­,è¯·è€å¿ƒç­‰å¾…...... ğŸ˜‹(${{env.WAREHOUSE_MAN}}ä»“åº“çš„#${{env.RUN_NUMBER}}å·)ï¼($(date +%Yå¹´%mæœˆ%då·%Hæ—¶%Måˆ†))ğŸ’" "http://www.pushplus.plus/send"
            fi
          fi
          if [[ "${{ env.INFORMATION_NOTICE }}" == "WX" ]]; then
            if [[ "${{steps.gitpush.outcome}}" == 'success' ]] && [[ "${{steps.compile.outcome}}" == 'success' ]]; then
              curl -k --data token="${{ secrets.WX_TOKEN }}" --data title="å¼€å§‹ç¼–è¯‘ã€${{ env.FOLDER_NAME }}ã€‘" --data "message=ğŸ‰ ä¸»äººğŸ’•ï¼šæ‚¨çš„ç¼–è¯‘è„šæœ¬æˆåŠŸè§¦å‘ã€${{ env.FOLDER_NAME }}ã€‘æ–‡ä»¶å¤¹ç¼–è¯‘ã€${{env.TARGET_PROFILE}}ã€‘å›ºä»¶ä¸­,è¯·è€å¿ƒç­‰å¾…...... ğŸ˜‹(${{env.Tongzhi_Date}})" "http://${{ secrets.CURL }}/push?token=${{ secrets.WX_TOKEN }}&"
            else
              curl -k --data token="${{ secrets.WX_TOKEN }}" --data title="è§¦å‘å¯åŠ¨å¤±è´¥" --data "message=ğŸ’¥ä¸»äººâŒ ï¼šè„šæœ¬é”™è¯¯,è§¦å‘å¯åŠ¨ã€${{ env.FOLDER_NAME }}ã€‘å¤±è´¥,è¯·ç‚¹å‡»è§¦å‘è„šæœ¬æ­¥éª¤æŸ¥çœ‹è¯¦æƒ…!(${{env.Tongzhi_Date}})" "http://${{ secrets.CURL }}/push?token=${{ secrets.WX_TOKEN }}&"
              exit 1
            fi
          fi
